#include "lookuptable_grayscale.h"

float lookuptable_R[256] = {0.000000, 0.212600, 0.425200, 0.637800, 0.850400, 1.063000,
                            1.275600, 1.488200, 1.700800, 1.913400, 2.126000, 2.338600,
                            2.551200, 2.763800, 2.976400, 3.189000, 3.401600, 3.614200,
                            3.826800, 4.039400, 4.252000, 4.464600, 4.677200, 4.889800,
                            5.102400, 5.315000, 5.527600, 5.740200, 5.952800, 6.165400,
                            6.378000, 6.590600, 6.803200, 7.015800, 7.228400, 7.441000,
                            7.653600, 7.866199, 8.078800, 8.291400, 8.504000, 8.716599,
                            8.929199, 9.141800, 9.354400, 9.566999, 9.779600, 9.992200,
                            10.204800, 10.417399, 10.629999, 10.842600, 11.055200, 11.267799,
                            11.480400, 11.693000, 11.905600, 12.118199, 12.330799, 12.543400,
                            12.756000, 12.968599, 13.181200, 13.393800, 13.606400, 13.818999,
                            14.031599, 14.244200, 14.456800, 14.669399, 14.882000, 15.094600,
                            15.307199, 15.519799, 15.732399, 15.945000, 16.157600, 16.370199,
                            16.582800, 16.795399, 17.007999, 17.220600, 17.433199, 17.645800,
                            17.858398, 18.070999, 18.283600, 18.496199, 18.708799, 18.921400,
                            19.133999, 19.346600, 19.559200, 19.771799, 19.984400, 20.196999,
                            20.409599, 20.622200, 20.834799, 21.047400, 21.259998, 21.472599,
                            21.685200, 21.897799, 22.110399, 22.323000, 22.535599, 22.748199,
                            22.960800, 23.173399, 23.386000, 23.598598, 23.811199, 24.023800,
                            24.236399, 24.448999, 24.661598, 24.874199, 25.086800, 25.299398,
                            25.511999, 25.724600, 25.937199, 26.149799, 26.362400, 26.574999,
                            26.787600, 27.000198, 27.212799, 27.425400, 27.637999, 27.850599,
                            28.063198, 28.275799, 28.488400, 28.700998, 28.913599, 29.126200,
                            29.338799, 29.551399, 29.764000, 29.976599, 30.189199, 30.401798,
                            30.614399, 30.827000, 31.039598, 31.252199, 31.464798, 31.677399,
                            31.889999, 32.102600, 32.315201, 32.527798, 32.740398, 32.952999,
                            33.165600, 33.378201, 33.590797, 33.803398, 34.015999, 34.228600,
                            34.441200, 34.653797, 34.866398, 35.078999, 35.291599, 35.504200,
                            35.716797, 35.929398, 36.141998, 36.354599, 36.567200, 36.779800,
                            36.992397, 37.204998, 37.417599, 37.630199, 37.842800, 38.055397,
                            38.267998, 38.480598, 38.693199, 38.905800, 39.118401, 39.330997,
                            39.543598, 39.756199, 39.968800, 40.181400, 40.393997, 40.606598,
                            40.819199, 41.031799, 41.244400, 41.456997, 41.669598, 41.882198,
                            42.094799, 42.307400, 42.519997, 42.732597, 42.945198, 43.157799,
                            43.370399, 43.583000, 43.795597, 44.008198, 44.220798, 44.433399,
                            44.646000, 44.858597, 45.071198, 45.283798, 45.496399, 45.709000,
                            45.921600, 46.134197, 46.346798, 46.559399, 46.771999, 46.984600,
                            47.197197, 47.409798, 47.622398, 47.834999, 48.047600, 48.260197,
                            48.472797, 48.685398, 48.897999, 49.110600, 49.323196, 49.535797,
                            49.748398, 49.960999, 50.173599, 50.386200, 50.598797, 50.811398,
                            51.023998, 51.236599, 51.449200, 51.661797, 51.874397, 52.086998,
                            52.299599, 52.512199, 52.724800, 52.937397, 53.149998, 53.362598,
                            53.575199, 53.787800, 54.000397, 54.212997};

float lookuptable_G[256] = {0.000000, 0.715200, 1.430400, 2.145600, 2.860800, 3.576000, 4.291200,
                            5.006400, 5.721600, 6.436800, 7.152000, 7.867200, 8.582400, 9.297600,
                            10.012800, 10.728000, 11.443200, 12.158401, 12.873600, 13.588800,
                            14.304000, 15.019200, 15.734400, 16.449600, 17.164801, 17.880001,
                            18.595200, 19.310400, 20.025600, 20.740801, 21.455999, 22.171200,
                            22.886400, 23.601601, 24.316801, 25.032000, 25.747200, 26.462400,
                            27.177601, 27.892799, 28.608000, 29.323200, 30.038401, 30.753601,
                            31.468800, 32.184002, 32.899200, 33.614399, 34.329601, 35.044800,
                            35.760002, 36.475201, 37.190399, 37.905602, 38.620800, 39.335999,
                            40.051201, 40.766399, 41.481602, 42.196800, 42.911999, 43.627201,
                            44.342400, 45.057602, 45.772800, 46.487999, 47.203201, 47.918400,
                            48.633602, 49.348801, 50.063999, 50.779202, 51.494400, 52.209602,
                            52.924801, 53.639999, 54.355202, 55.070400, 55.785599, 56.500801,
                            57.216000, 57.931202, 58.646400, 59.361599, 60.076801, 60.792000,
                            61.507202, 62.222401, 62.937599, 63.652802, 64.368004, 65.083199,
                            65.798401, 66.513603, 67.228798, 67.944000, 68.659203, 69.374397,
                            70.089600, 70.804802, 71.520004, 72.235199, 72.950401, 73.665604,
                            74.380798, 75.096001, 75.811203, 76.526398, 77.241600, 77.956802,
                            78.671997, 79.387199, 80.102402, 80.817604, 81.532799, 82.248001,
                            82.963203, 83.678398, 84.393600, 85.108803, 85.823997, 86.539200,
                            87.254402, 87.969604, 88.684799, 89.400002, 90.115204, 90.830399,
                            91.545601, 92.260803, 92.975998, 93.691200, 94.406403, 95.121597,
                            95.836800, 96.552002, 97.267204, 97.982399, 98.697601, 99.412804,
                            100.127998, 100.843201, 101.558403, 102.273598, 102.988800, 103.704002,
                            104.419205, 105.134399, 105.849602, 106.564804, 107.279999, 107.995201,
                            108.710403, 109.425598, 110.140800, 110.856003, 111.571198, 112.286400,
                            113.001602, 113.716805, 114.431999, 115.147202, 115.862404, 116.577599,
                            117.292801, 118.008003, 118.723198, 119.438400, 120.153603, 120.868805,
                            121.584000, 122.299202, 123.014404, 123.729599, 124.444801, 125.160004,
                            125.875198, 126.590401, 127.305603, 128.020798, 128.736008, 129.451202,
                            130.166397, 130.881607, 131.596802, 132.311996, 133.027206, 133.742401,
                            134.457596, 135.172806, 135.888000, 136.603195, 137.318405, 138.033600,
                            138.748795, 139.464005, 140.179199, 140.894394, 141.609604, 142.324799,
                            143.040009, 143.755203, 144.470398, 145.185608, 145.900803, 146.615997,
                            147.331207, 148.046402, 148.761597, 149.476807, 150.192001, 150.907196,
                            151.622406, 152.337601, 153.052795, 153.768005, 154.483200, 155.198395,
                            155.913605, 156.628799, 157.343994, 158.059204, 158.774399, 159.489609,
                            160.204803, 160.919998, 161.635208, 162.350403, 163.065598, 163.780807,
                            164.496002, 165.211197, 165.926407, 166.641602, 167.356796, 168.072006,
                            168.787201, 169.502396, 170.217606, 170.932800, 171.647995, 172.363205,
                            173.078400, 173.793594, 174.508804, 175.223999, 175.939209, 176.654404,
                            177.369598, 178.084808, 178.800003, 179.515198, 180.230408, 180.945602,
                            181.660797, 182.376007};

float lookuptable_B[256] = {0.000000, 0.072200, 0.144400, 0.216600, 0.288800, 0.361000, 0.433200,
                            0.505400, 0.577600, 0.649800, 0.722000, 0.794200, 0.866400, 0.938600,
                            1.010800, 1.083000, 1.155200, 1.227400, 1.299600, 1.371800, 1.444000,
                            1.516200, 1.588400, 1.660600, 1.732800, 1.805000, 1.877200, 1.949400,
                            2.021600, 2.093800, 2.166000, 2.238200, 2.310400, 2.382600, 2.454800,
                            2.527000, 2.599200, 2.671400, 2.743600, 2.815800, 2.888000, 2.960200,
                            3.032400, 3.104600, 3.176800, 3.249000, 3.321200, 3.393400, 3.465600,
                            3.537800, 3.610000, 3.682200, 3.754400, 3.826600, 3.898800, 3.971000,
                            4.043200, 4.115400, 4.187600, 4.259800, 4.332000, 4.404200, 4.476400,
                            4.548600, 4.620800, 4.693000, 4.765200, 4.837400, 4.909600, 4.981800,
                            5.054000, 5.126200, 5.198400, 5.270600, 5.342800, 5.415000, 5.487200,
                            5.559400, 5.631600, 5.703800, 5.776000, 5.848200, 5.920400, 5.992600,
                            6.064800, 6.137000, 6.209200, 6.281400, 6.353600, 6.425800, 6.498000,
                            6.570200, 6.642400, 6.714600, 6.786800, 6.859000, 6.931200, 7.003400,
                            7.075600, 7.147800, 7.220000, 7.292200, 7.364400, 7.436600, 7.508800,
                            7.581000, 7.653200, 7.725400, 7.797600, 7.869800, 7.942000, 8.014200,
                            8.086400, 8.158600, 8.230800, 8.303000, 8.375200, 8.447400, 8.519600,
                            8.591800, 8.664000, 8.736200, 8.808400, 8.880600, 8.952800, 9.025000,
                            9.097200, 9.169400, 9.241600, 9.313800, 9.386000, 9.458200, 9.530400,
                            9.602600, 9.674800, 9.747000, 9.819201, 9.891400, 9.963600, 10.035800,
                            10.108000, 10.180200, 10.252400, 10.324600, 10.396800, 10.469000,
                            10.541200, 10.613400, 10.685600, 10.757800, 10.830000, 10.902200,
                            10.974400, 11.046600, 11.118800, 11.191000, 11.263200, 11.335400,
                            11.407600, 11.479800, 11.552000, 11.624200, 11.696400, 11.768600,
                            11.840800, 11.913000, 11.985200, 12.057400, 12.129601, 12.201800,
                            12.274000, 12.346200, 12.418400, 12.490600, 12.562800, 12.635000,
                            12.707200, 12.779400, 12.851600, 12.923800, 12.996000, 13.068200,
                            13.140400, 13.212600, 13.284800, 13.357000, 13.429200, 13.501400,
                            13.573600, 13.645800, 13.718000, 13.790200, 13.862400, 13.934600,
                            14.006800, 14.079000, 14.151200, 14.223400, 14.295600, 14.367800,
                            14.440001, 14.512200, 14.584400, 14.656600, 14.728800, 14.801000,
                            14.873200, 14.945400, 15.017600, 15.089800, 15.162000, 15.234200,
                            15.306400, 15.378600, 15.450800, 15.523000, 15.595200, 15.667400,
                            15.739600, 15.811800, 15.884000, 15.956200, 16.028400, 16.100599,
                            16.172800, 16.245001, 16.317200, 16.389400, 16.461599, 16.533800,
                            16.606001, 16.678200, 16.750401, 16.822599, 16.894800, 16.967001,
                            17.039200, 17.111401, 17.183599, 17.255800, 17.327999, 17.400200,
                            17.472401, 17.544600, 17.616800, 17.688999, 17.761200, 17.833401,
                            17.905600, 17.977800, 18.049999, 18.122200, 18.194401, 18.266600,
                            18.338800, 18.410999};




void brightness_contrast_V4(
        const uint8_t *img, size_t width, size_t height,
        float a, float b, float c,
        int16_t brightness, float contrast,
        uint8_t *result) {

    size_t pixelCount = width * height;

    float mean_brightened = 0.0f;
    if (a != 0.2126f) {
        float reciprocal_of_sum_of_coeffs = 1 / (a + b + c);
        float ra = a * reciprocal_of_sum_of_coeffs;
        for (size_t i = 0; i < 255; i++) {
            lookuptable_R[i] = ra * i;
        }
    }
    if (b != 0.7152f) {
        float reciprocal_of_sum_of_coeffs = 1 / (a + b + c);
        float rb = b * reciprocal_of_sum_of_coeffs;
        for (size_t i = 0; i < 255; i++) {
            lookuptable_R[i] = rb * i;
        }
    }
    if (c != 0.0722f) {
        float reciprocal_of_sum_of_coeffs = 1 / (a + b + c);
        float rc = c * reciprocal_of_sum_of_coeffs;
        for (size_t i = 0; i < 255; i++) {
            lookuptable_R[i] = rc * i;
        }
    }

    // Calculate brightness and mean brightness
    for (size_t i = 0; i < pixelCount; ++i) {
        const uint8_t *pixel = &img[i * 3];
        float D = lookuptable_R[pixel[0]] + lookuptable_G[pixel[1]] + lookuptable_B[pixel[2]];
        int Q_prime = CLAMP((int) D + brightness);
        result[i] = Q_prime;
        mean_brightened += Q_prime;
    }
    mean_brightened /= pixelCount;
    float variance_afterBrightness = 0.0f;

    for (size_t i = 0; i < pixelCount; ++i) {
        variance_afterBrightness += (result[i] - mean_brightened) * (result[i] - mean_brightened);
    }
    variance_afterBrightness /= pixelCount;
    // now we adjust the contrast using the given variable
    float std_dev = sqrtf(variance_afterBrightness);
    float contrast_factor = ((std_dev == 0) ? 0 : contrast / std_dev);
    // Apply contrast adjustment to each pixel
    for (size_t i = 0; i < pixelCount; ++i) {
        float Q_double_prime = (contrast_factor * result[i]) + ((1 - contrast_factor) * mean_brightened);
        result[i] = CLAMP((int) Q_double_prime);
    }
}


